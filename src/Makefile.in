CC=@CC@
SWIG=@SWIG@
PYDEV=@PYDEV@
PYLIB=@PYLIB@
LDFLAGS=@LDFLAGS@
CFLAGS=@CFLAGS@
prefix=@prefix@
exec_prefix=@exec_prefix@
LIBDIR=@libdir@
INCDIR=@includedir@
LLIBDIR=/usr/lib
INC=-I$(PYDEV)
TARGET=mpsse

all: $(TARGET) swig

$(TARGET): mpsse.o
	gcc -shared -Wl,-soname,lib$(TARGET).so $(TARGET).o support.o -o lib$(TARGET).so $(LDFLAGS)
	ar rcs lib$(TARGET).a $(TARGET).o support.o

examples: spiflash i2ceeprom

spiflash:
	$(CC) $(CFLAGS) examples/spiflash.c -o examples/spiflash -lmpsse

i2ceeprom:
	$(CC) $(CFLAGS) examples/i2ceeprom.c -o examples/i2ceeprom -lmpsse

mpsse.o: support.o
	$(CC) $(CFLAGS) $(LDFLAGS) -c mpsse.c

support.o:
	$(CC) $(CFLAGS) $(LDFLAGS) -c support.c

swig:
	$(CC) $(CFLAGS) $(LDFLAGS) -DSWIGPYTHON -c support.c
	$(CC) $(CFLAGS) $(LDFLAGS) -DSWIGPYTHON -c mpsse.c
	$(SWIG) -python $(TARGET).i
	$(CC) $(CFLAGS) -c  $(TARGET)_wrap.c  $(INC)
	ld -shared $(TARGET)_wrap.o mpsse.o support.o -o _$(TARGET).so $(LDFLAGS) $(INC)

install: uninstall
	cp lib$(TARGET).so $(LIBDIR)/lib$(TARGET).so
	cp lib$(TARGET).a $(LIBDIR)/lib$(TARGET).a
	ln -s $(LIBDIR)/lib$(TARGET).so $(LLIBDIR)/lib$(TARGET).so
	ln -s $(LIBDIR)/lib$(TARGET).a $(LLIBDIR)/lib$(TARGET).a
	cp $(TARGET).h $(INCDIR)/$(TARGET).h
	cp $(TARGET).py $(PYLIB)/$(TARGET).py
	cp _$(TARGET).so $(PYLIB)/_$(TARGET).so

uninstall:
	rm -f $(LIBDIR)/lib$(TARGET).so $(LIBDIR)/lib$(TARGET).a
	rm -f $(LLIBDIR)/lib$(TARGET).so $(LLIBDIR)/lib$(TARGET).a
	rm -f $(PYLIB)/$(TARGET).* $(PYLIB)/_$(TARGET).so
	rm -f $(INCDIR)/$(TARGET).h

clean:
	rm -f examples/spiflash examples/i2ceeprom *.o *.so *.a $(TARGET).py* $(TARGET)_wrap.c

cleanall: clean
	rm -rf *.cache config.* Makefile

